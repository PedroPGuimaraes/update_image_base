name: Modificar Arquivo Base Image

on:
  push:
    tags:
      - "*"

jobs:
  modify-file:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: Checkout do Reposit√≥rio Atual
        uses: actions/checkout@v2

      - name: Setup credentials to access private repositories
        run: git config --global url.https://${{ secrets.PAT_TOKEN }}@github.com/.insteadOf https://github.com/
      
      - name: Check for changes
        run: |
          git clone https://github.com/PedroPGuimaraes/image_base.git
          git config --global user.email "p.guimaraes@4intelligence.ai"
          git config --global user.name "PedroPGuimaraes"

          cd image_base
          git checkout -b 'branch-${{ github.ref_name }}'
          
          sed -i 's/"image_base.git"/c\" R -q -e 'remotes::install_github("PedroPGuimaraes/image_base.git@${{ github.ref_name }}", auth_token = "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", dependencies = c("Imports"), force = TRUE, upgrade = FALSE)'  \"/g' Dockerfile

          git add .
          git commit -m "Update Dockerfile"
          git push origin 'branch-${{ github.ref_name }}'
          
      
      - name: Open Pull Request
        run: |
          cd image_base

          pr_count=$(gh pr list --state open --base main --head 'branch-${{ github.ref_name }}' --limit 1 | wc -l)
          
          if [[ "$pr_count" -gt 0 ]]; then
            echo "There is already an open pull request. Exiting..."
            exit 0
          else
            cd image_base
            gh pr create --base main --head 'branch-${{ github.ref_name }}' --title "Update Dockerfile" --body "Changes in Dockerfile"
          fi
      
